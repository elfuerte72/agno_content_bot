#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–∞–Ω–∞–ª–∞ Telegram
"""

import asyncio
import logging
from aiogram import Bot
from dotenv import load_dotenv
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

load_dotenv()

async def setup_channel():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–∞–ª–∞"""
    bot = Bot(token=os.getenv('TELEGRAM_BOT_TOKEN'))
    
    try:
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
        bot_info = await bot.get_me()
        print(f"ü§ñ –ë–æ—Ç: @{bot_info.username} (ID: {bot_info.id})")
        print(f"üìù –ò–º—è: {bot_info.first_name}")
        print()
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–Ω–∞–ª—ã
        channels_to_check = [
            "@optimaai_tg",
            os.getenv('TELEGRAM_CHANNEL_ID'),
            os.getenv('TELEGRAM_CHANNEL_USERNAME')
        ]
        
        # –£–±—Ä–∞—Ç—å –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        channels_to_check = [ch for ch in channels_to_check if ch]
        
        print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–∞–ª–æ–≤:")
        print("-" * 50)
        
        for channel in channels_to_check:
            print(f"\nüì∫ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–∞–ª–∞: {channel}")
            
            try:
                # –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ
                chat = await bot.get_chat(channel)
                print(f"‚úÖ –ö–∞–Ω–∞–ª –Ω–∞–π–¥–µ–Ω!")
                print(f"   ID: {chat.id}")
                print(f"   –ù–∞–∑–≤–∞–Ω–∏–µ: {chat.title}")
                print(f"   Username: @{chat.username if chat.username else '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}")
                print(f"   –¢–∏–ø: {chat.type}")
                print(f"   –û–ø–∏—Å–∞–Ω–∏–µ: {chat.description[:100] if chat.description else '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}...")
                
                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                try:
                    admins = await bot.get_chat_administrators(chat.id)
                    print(f"   üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {len(admins)}")
                    
                    bot_is_admin = False
                    bot_permissions = None
                    
                    for admin in admins:
                        if admin.user.id == bot_info.id:
                            bot_is_admin = True
                            bot_permissions = admin
                            break
                    
                    if bot_is_admin:
                        print(f"   ‚úÖ –ë–æ—Ç —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
                        
                        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞
                        perms = bot_permissions
                        if hasattr(perms, 'can_post_messages'):
                            print(f"   üìù –ú–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: {'‚úÖ' if perms.can_post_messages else '‚ùå'}")
                        if hasattr(perms, 'can_edit_messages'):
                            print(f"   ‚úèÔ∏è –ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: {'‚úÖ' if perms.can_edit_messages else '‚ùå'}")
                        if hasattr(perms, 'can_delete_messages'):
                            print(f"   üóëÔ∏è –ú–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: {'‚úÖ' if perms.can_delete_messages else '‚ùå'}")
                            
                    else:
                        print(f"   ‚ùå –ë–æ—Ç –ù–ï —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
                        print(f"   üí° –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ @{bot_info.username} –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∫–∞–Ω–∞–ª–∞")
                        print(f"   üìã –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞:")
                        print(f"      - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π")
                        print(f"      - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")
                        
                except Exception as admin_error:
                    print(f"   ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {admin_error}")
                    
                # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                try:
                    test_message = await bot.send_message(
                        chat_id=chat.id,
                        text="üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞\n\n–≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –±–æ—Ç –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –∫–∞–Ω–∞–ª–µ.",
                        parse_mode='Markdown'
                    )
                    print(f"   ‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (ID: {test_message.message_id})")
                    
                    # –£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    await asyncio.sleep(2)
                    try:
                        await bot.delete_message(chat.id, test_message.message_id)
                        print(f"   üóëÔ∏è –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ")
                    except:
                        print(f"   ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
                        
                except Exception as send_error:
                    print(f"   ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {send_error}")
                    
                # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è .env —Ñ–∞–π–ª–∞
                print(f"\nüìã –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è .env:")
                print(f"TELEGRAM_CHANNEL_ID={chat.id}")
                print(f"TELEGRAM_CHANNEL_USERNAME=@{chat.username}")
                
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–∞–Ω–∞–ª–∞ {channel}: {e}")
                
                # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫
                error_msg = str(e).lower()
                if "chat not found" in error_msg:
                    print(f"   üí° –ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
                    print(f"      - –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∫–∞–Ω–∞–ª–∞")
                    print(f"      - –ö–∞–Ω–∞–ª –ø—Ä–∏–≤–∞—Ç–Ω—ã–π")
                    print(f"      - –ë–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª")
                elif "forbidden" in error_msg:
                    print(f"   üí° –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
                    print(f"      - –ë–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª")
                    print(f"      - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤")
                    
        print("\n" + "=" * 50)
        print("üéØ –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ù–ê–°–¢–†–û–ô–ö–ï:")
        print("=" * 50)
        print("1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª @optimaai_tg")
        print("2. –ù–∞–∑–Ω–∞—á—å—Ç–µ –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Å –ø—Ä–∞–≤–∞–º–∏:")
        print("   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π")
        print("   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")
        print("3. –û–±–Ω–æ–≤–∏—Ç–µ .env —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏")
        print("4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞")
        
    finally:
        await bot.session.close()

if __name__ == "__main__":
    asyncio.run(setup_channel())